// Code generated by goa v3.22.6, DO NOT EDIT.
//
// assistant-mcp MCP executor
//
// Command:
// $ goa gen example.com/assistant/design

package assistant_mcp

import (
	"context"
	"encoding/json"
	"strings"

	assistant_mcp "example.com/assistant/gen/orchestrator/agents/chat/specs/assistant_mcp"
	"goa.design/goa-ai/runtime/agent/planner"
	runtime "goa.design/goa-ai/runtime/agent/runtime"
	"goa.design/goa-ai/runtime/agent/telemetry"
	mcpruntime "goa.design/goa-ai/runtime/mcp"
)

// NewChatAssistantMcpMCPExecutor returns a ToolCallExecutor that
// proxies tool calls to an MCP caller using generated per-toolset codecs.
func NewChatAssistantMcpMCPExecutor(caller mcpruntime.Caller) runtime.ToolCallExecutor {
	suite := "assistant.assistant-mcp"
	prefix := suite + "."

	return runtime.ToolCallExecutorFunc(func(ctx context.Context, meta runtime.ToolCallMeta, call planner.ToolRequest) (planner.ToolResult, error) {
		full := call.Name
		tool := full
		if strings.HasPrefix(tool, prefix) {
			tool = tool[len(prefix):]
		}

		// Encode payload using generated codec
		if pc, ok := assistant_mcp.PayloadCodec(full); ok {
			// When ExecuteToolActivity already decoded payload into a typed value,
			// PayloadCodec will encode it deterministically for transport.
			payload, err := pc.ToJSON(call.Payload)
			if err != nil {
				return planner.ToolResult{Name: full, Error: planner.ToolErrorFromError(err)}, nil
			}
			resp, err := caller.CallTool(ctx, mcpruntime.CallRequest{Suite: suite, Tool: tool, Payload: payload})
			if err != nil {
				return planner.ToolResult{Name: full, Error: planner.ToolErrorFromError(err)}, nil
			}
			var value any
			if len(resp.Result) > 0 {
				if rc, ok := assistant_mcp.ResultCodec(full); ok {
					v, err := rc.FromJSON(resp.Result)
					if err != nil {
						return planner.ToolResult{Name: full, Error: planner.ToolErrorFromError(err)}, nil
					}
					value = v
				}
			}
			var tel *telemetry.ToolTelemetry
			if len(resp.Structured) > 0 {
				tel = &telemetry.ToolTelemetry{Extra: map[string]any{"structured": json.RawMessage(resp.Structured)}}
			}
			return planner.ToolResult{Name: full, Result: value, Telemetry: tel}, nil
		}
		return planner.ToolResult{Name: full, Error: planner.NewToolError("payload codec not found")}, nil
	})
}

# Implementation Plan

- [x] 1. Extract shared expression builder infrastructure
  - [x] 1.1 Create shared/expr_builder_base.go with protocolExprBuilderBase type
    - Implement PrepareAndValidate, collectUserTypes, getOrCreateType, userTypeAttr methods
    - Use deterministic sorting (insertion sort) for type collection
    - _Requirements: 1.1, 1.5_
  - [x] 1.2 Write property test for deterministic user type collection
    - **Property 1: Deterministic User Type Collection**
    - **Validates: Requirements 1.5**
  - [x] 1.3 Create shared/import_utils.go with joinImportPath and gatherAttributeImports
    - Move from MCP-specific implementations to shared package
    - Remove joinImportPathMCP and gatherAttributeImportsMCP duplicates
    - _Requirements: 12.1, 12.2, 12.3_
  - [x] 1.4 Write property test for import path resolution consistency
    - **Property 14: Import Path Resolution Consistency**
    - **Validates: Requirements 12.4**
  - [x] 1.5 Create shared/protocol_config.go with ProtocolConfig interface
    - Define JSONRPCPath, ProtocolVersion, Capabilities, Name methods
    - _Requirements: 13.1_
  - [x] 1.6 Create buildHTTPServiceBase helper in shared package
    - Configure JSON-RPC routes and SSE endpoints using ProtocolConfig
    - _Requirements: 1.4_

- [x] 2. Refactor MCP expression builder to use shared base
  - [x] 2.1 Update mcpExprBuilder to embed protocolExprBuilderBase
    - Replace duplicated methods with delegation to base
    - Implement mcpConfig for ProtocolConfig interface
    - _Requirements: 1.3_
  - [x] 2.2 Update MCP generate.go to use shared import utilities
    - Replace joinImportPathMCP with joinImportPath
    - Replace gatherAttributeImportsMCP with gatherAttributeImports
    - _Requirements: 12.3_
  - [x] 2.3 Verify existing MCP tests still pass
    - Run make test to ensure no regressions
    - _Requirements: 10.1_

- [x] 3. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 4. Refactor A2A expression builder to use shared base
  - [x] 4.1 Update a2aExprBuilder to embed protocolExprBuilderBase
    - Replace duplicated methods with delegation to base
    - Implement a2aConfig for ProtocolConfig interface
    - _Requirements: 1.2_
  - [x] 4.2 Update buildHTTPService to use buildHTTPServiceBase
    - Pass a2aConfig to shared helper
    - _Requirements: 1.4_
  - [x] 4.3 Write property test for protocol config path usage
    - **Property 15: Protocol Config Path Usage**
    - **Validates: Requirements 13.2**
  - [x] 4.4 Write property test for capability inclusion
    - **Property 16: Capability Inclusion**
    - **Validates: Requirements 13.3**

- [x] 5. Create A2A adapter generator
  - [x] 5.1 Create a2a_adapter_generator.go with a2aAdapterGenerator struct
    - Mirror MCP's adapterGenerator pattern
    - Include genpkg, agent, and NameScope fields
    - _Requirements: 2.1_
  - [x] 5.2 Implement buildAdapterData method
    - Compute skill metadata, security schemes, type references
    - Use NameScope.GoFullTypeRef for type references
    - _Requirements: 2.3_
  - [x] 5.3 Implement getTypeReference method using NameScope helpers
    - Handle external user types with locators
    - Handle composites (arrays, maps) correctly
    - _Requirements: 2.2_
  - [x] 5.4 Write property test for type reference consistency
    - **Property 2: Type Reference Consistency**
    - **Validates: Requirements 2.2**
  - [x] 5.5 Implement skill schema generation using MCP's toJSONSchema
    - Derive input schemas from exported tool payloads
    - _Requirements: 2.4_
  - [x] 5.6 Write property test for schema generation consistency
    - **Property 3: Schema Generation Consistency**
    - **Validates: Requirements 2.4**

- [x] 6. Modularize A2A adapter templates
  - [x] 6.1 Create a2a_adapter_core.go.tpl with struct, constructor, helpers
    - Extract core adapter structure from monolithic template
    - _Requirements: 9.1_
  - [x] 6.2 Create a2a_adapter_tasks.go.tpl for task operations
    - TasksSend, TasksSendSubscribe, TasksGet, TasksCancel
    - _Requirements: 9.2_
  - [x] 6.3 Create a2a_adapter_card.go.tpl for agent card
    - AgentCard method with inlined skills and security (specialized at generation time)
    - _Requirements: 9.3, 9.4_
  - [x] 6.4 Inline security schemes in card template
    - Security schemes and requirements are static data, inlined in AgentCard
    - _Requirements: 9.4_
  - [x] 6.5 Update a2a_service.go to compose template sections
    - Use multiple SectionTemplates instead of single template
    - _Requirements: 2.5, 9.1_

- [x] 7. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 8. Consolidate security scheme handling
  - [x] 8.1 Ensure buildA2ASecurityData is called from single location
    - Update a2a_service.go to call once and pass to adapter data
    - Remove duplicate calls in a2a_card.go and a2a_client.go
    - _Requirements: 8.1_
  - [x] 8.2 Update adapter data to include security schemes
    - Pass security data through A2AAdapterData structure
    - _Requirements: 8.2_
  - [x] 8.3 Update card data to receive security from adapter data
    - Remove separate buildA2ASecurityData call
    - _Requirements: 8.3_
  - [x] 8.4 Update client generation to use same security definitions
    - Generate auth providers from adapter data security schemes
    - _Requirements: 8.4_
  - [x] 8.5 Write property test for security scheme mapping round-trip
    - **Property 12: Security Scheme Mapping Round-Trip**
    - **Validates: Requirements 10.4**
  - [x] 8.6 Verify OAuth2 client_credentials and authorization_code flows
    - Test both flow types are handled correctly
    - _Requirements: 8.5_

- [x] 9. Refactor A2A client to use Goa's JSON-RPC codegen
  - [x] 9.1 Update a2aServiceFiles to use jsonrpccodegen.ClientFiles
    - Replace handwritten client template with Goa-generated client
    - _Requirements: 3.1_
  - [x] 9.2 Create patchA2AJSONRPCClientFiles function
    - Mirror patchMCPJSONRPCClientFiles pattern
    - Add SSE Accept header for streaming methods
    - _Requirements: 3.2_
  - [x] 9.3 Configure SSE through Goa's streaming mechanisms
    - Set Stream = expr.ServerStreamKind for streaming methods
    - Configure SSE endpoints in HTTP service
    - _Requirements: 3.3_
  - [x] 9.4 Generate auth helpers from security scheme definitions
    - Create typed auth providers for each scheme type
    - _Requirements: 3.4_
  - [x] 9.5 Write property test for auth helper generation
    - **Property 4: Auth Helper Generation Consistency**
    - **Validates: Requirements 3.4**
  - [x] 9.6 Implement structured error types for JSON-RPC errors
    - Create A2AError type with Code, Message, Data fields
    - _Requirements: 3.5_
  - [x] 9.7 Write property test for structured error codes
    - **Property 5: Structured Error Codes**
    - **Validates: Requirements 3.5**

- [x] 10. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 11. Establish A2A types as single source of truth
  - [x] 11.1 Verify all A2A types are defined in a2a_types.go
    - Created a2a_types.go.tpl template with all shared A2A types
    - _Requirements: 4.1_
  - [x] 11.2 Update templates to import types from generated package
    - Types are now in a single types.go file in the a2a package
    - _Requirements: 4.2_
  - [x] 11.3 Update agent card template to use generated types
    - Removed duplicate type definitions from a2a_card.go.tpl
    - _Requirements: 4.3_
  - [x] 11.4 Update client template to use generated types
    - Removed duplicate type definitions from a2a_client.go.tpl
    - _Requirements: 4.4_
  - [x] 11.5 Write property test for type serialization round-trip
    - **Property 13: Type Serialization Round-Trip**
    - Added TestA2ATypesFileGeneration and TestA2ATypesConsistency
    - **Validates: Requirements 10.5**

- [x] 12. Add A2A retry support
  - [x] 12.1 Create runtime/a2a/retry/retry.go
    - Implement RetryConfig with MaxAttempts, backoff settings
    - Match MCP's retry package interface
    - _Requirements: 5.2_
  - [x] 12.2 Implement IsRetryable function
    - Check for network errors, 503, timeout errors
    - _Requirements: 5.1_
  - [x] 12.3 Implement WithRetry function with exponential backoff
    - Use configurable backoff factor and max backoff
    - _Requirements: 5.1_
  - [x] 12.4 Write property test for retry behavior
    - **Property 6: Retry Behavior**
    - **Validates: Requirements 5.1, 5.4**
  - [x] 12.5 Implement RetryExhaustedError for exhausted retries
    - Include last error, attempt count, total duration
    - _Requirements: 5.4_
  - [x] 12.6 Add reconnection support for streaming calls
    - Track last event ID for resumption
    - _Requirements: 5.3_
  - [x] 12.7 Write property test for streaming reconnection
    - **Property 7: Streaming Reconnection**
    - **Validates: Requirements 5.3**
  - [x] 12.8 Create a2a_client_retry.go.tpl for client retry helpers
    - Generate retry wrappers for client methods
    - _Requirements: 5.1_

- [x] 13. Add A2A policy injection
  - [x] 13.1 Create runtime/a2a/policy/policy.go
    - Define header constants and context keys
    - _Requirements: 6.1_
  - [x] 13.2 Implement ExtractPolicyFromHeaders function
    - Parse comma-separated skill lists from headers
    - _Requirements: 6.1_
  - [x] 13.3 Write property test for policy header extraction
    - **Property 8: Policy Header Extraction**
    - **Validates: Requirements 6.1, 6.2**
  - [x] 13.4 Implement InjectPolicyToContext function
    - Add allow/deny lists to context
    - _Requirements: 6.2_
  - [x] 13.5 Implement FilterSkills function
    - Apply allow/deny policy to skill list
    - _Requirements: 6.3_
  - [x] 13.6 Write property test for skill filtering correctness
    - **Property 9: Skill Filtering Correctness**
    - **Validates: Requirements 6.3**
  - [x] 13.7 Implement ValidateSkillAccess function
    - Check if skill is allowed by current policy
    - _Requirements: 6.4_
  - [x] 13.8 Write property test for skill access validation
    - **Property 10: Skill Access Validation**
    - **Validates: Requirements 6.4**
  - [x] 13.9 Update A2A server to inject policy from headers
    - Add middleware to extract and inject policy
    - _Requirements: 6.1, 6.2_

- [x] 14. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 15. Add A2A registration helpers
  - [x] 15.1 Create a2a_register.go with a2aRegisterFile function
    - Mirror MCP's registerFile pattern
    - _Requirements: 7.4_
  - [x] 15.2 Create a2a_register.go.tpl template
    - Generate registration helper with all skills
    - _Requirements: 7.1_
  - [x] 15.3 Include input/output schemas in registration
    - Derive schemas from tool payloads
    - _Requirements: 7.3_
  - [x] 15.4 Write property test for registration completeness
    - **Property 11: Registration Completeness**
    - **Validates: Requirements 7.2, 7.3**
  - [x] 15.5 Update a2aServiceFiles to generate registration helper
    - Call a2aRegisterFile and append to files
    - _Requirements: 7.1_

- [x] 16. Improve MCP patching mechanisms
  - [x] 16.1 Add pattern validation to patchMCPJSONRPCClientFiles
    - Check if expected patterns exist before replacing
    - Return error if pattern not found
    - _Requirements: 11.5_
  - [x] 16.2 Write property test for template patch failure detection
    - **Property 17: Template Patch Failure Detection**
    - **Validates: Requirements 11.5**
  - [x] 16.3 Document patching patterns for future maintenance
    - Add comments explaining each patch purpose
    - _Requirements: 11.1, 11.2_
  - [x] 16.4 Use Goa's AddImport helper consistently
    - Replace manual import manipulation with AddImport
    - _Requirements: 11.4_
  - [x] 16.5 Consider middleware pattern for context injection
    - Evaluate replacing string patches with interceptors
    - _Requirements: 11.3_

- [x] 17. Add comprehensive tests
  - [x] 17.1 Add unit tests for shared base type
    - Test PrepareAndValidate, collectUserTypes, getOrCreateType
    - _Requirements: 10.1_
  - [x] 17.2 Add golden file tests for A2A adapter generation
    - Compare generated output against expected files
    - _Requirements: 10.2_
  - [x] 17.3 Add integration tests for A2A JSON-RPC communication
    - Test client-server round-trip
    - _Requirements: 10.3_

- [x] 18. Final Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

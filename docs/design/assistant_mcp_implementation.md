# Goa Assistant MCP — Implementation Plan

## Goal

Implement an MCP server that helps users design, scaffold, and operate Goa systems the right way:

- Default multi‑service unified layout with top‑level design importing per‑service designs
- Single “goa gen” pipeline (idempotent, deterministic)
- Observability with Clue + OpenTelemetry
- Diagrams with Model (C4) + drift checks by default
- Internal client scaffolding (cmg for mocks)
- Testing (Goa testing plugin) with scenario scaffolds
- Clear JSON‑RPC streaming semantics and safety contracts

This plan is self‑contained and sufficient to implement the Assistant MCP from scratch.

---

## High‑Level Architecture

- Transport: JSON‑RPC over HTTP; SSE for streaming tools (Accept: `text/event-stream`).
- Server shell: a Goa project using the Goa MCP plugin, exposing an “assistant” service:
  - Assistant methods map to the tool handlers (e.g., `system.new`, `design.method.add`).
  - MCP adapter (generated by Goa MCP plugin) maps `tools/list` and `tools/call` to assistant methods.
- Tool registry: Static in code (name → description → argument schema → handler).
- Execution modules per tool family:
  - system: create/plan/apply/upgrade/validate
  - design: method.add, review, conventions
  - codegen: generate
  - diagrams: configure, generate, check
  - observability: setup
  - clients: scaffold + cmg integration
  - http/grpc: cors.configure, middleware.add, interceptors.add
  - testing: configure, scenario.add
  - workspace: module.add/remove
  - plugin: explain, new, review
  - help: tool.help (schemas/examples)
- Safety & consistency:
  - Write Tools Safety Contract enforced centrally (path bounding, dryRun/plan, no writes under `gen/`, dirty worktree handling, progress events).
  - Concurrency control: per‑workspace lock for codegen/plan/apply.

---

## Repository Layout (Assistant MCP)

```
/<module>
├── go.mod
├── design/design.go                 # Assistant service design (tools → methods)
├── gen/…                            # goa gen output
├── cmd/goa_mcp_assistant/…          # example main (JSON-RPC server at /rpc)
├── internal/
│   ├── registry/                    # tool catalog (descriptions, schemas, examples, handlers)
│   ├── tools/
│   │   ├── system/                  # new, plan, apply, upgrade, validate
│   │   ├── design/                  # method.add, review, conventions
│   │   ├── codegen/                 # generate
│   │   ├── diagrams/                # configure, generate, check
│   │   ├── observability/           # setup
│   │   ├── clients/                 # scaffold + cmg mocks
│   │   ├── http/                    # cors.configure, middleware.add
│   │   ├── grpc/                    # interceptors.add
│   │   ├── testing/                 # configure, scenario.add
│   │   ├── workspace/               # module.add, module.remove
│   │   └── plugin/                  # explain, new, review
│   ├── fs/                          # safe fs ops, planning, diff
│   ├── exec/                        # goa/gen, mdl/stz, cmg, go, git runners
│   ├── schema/                      # JSON Schemas for arguments (served by tool.help)
│   └── progress/                    # SSE event helpers
├── docs/design/assistant_mcp.md     # Tool specification (what the MCP exposes)
└── docs/design/assistant_mcp_implementation.md  # This implementation plan
```

---

## Dependencies (pinned)

- Goa: `goa.design/goa/v3` v3.22.2+
- MCP plugin: `goa.design/goa-ai` v3.x
- Clue: `goa.design/clue` v1.2.2+ (log/debug/health; cmg generator)
- Model: `goa.design/model` latest
- Model plugin (drift): `goa.design/plugins/v3/model` (DSL import)
- Testing plugin: `goa.design/plugins/v3/testing` (DSL import)

External CLIs executed via `exec`:
- goa: `goa.design/goa/v3/cmd/goa`
- cmg: `goa.design/clue/mock/cmd/cmg`
- mdl, stz (optional): `goa.design/model/cmd/mdl`, `goa.design/model/cmd/stz`
- go, git

---

## Initialization & Code Generation

1) Module & plugins
```
go mod init <module>
go get goa.design/goa/v3@v3.22.2
go get goa.design/goa-ai@latest
go get goa.design/clue@latest
go get goa.design/model@latest
```

2) Assistant design (design/design.go)
- API("goa-assistant"), Service("assistant")
- JSONRPC/POST("/rpc")
- Methods = tools (use streaming for long operations with named types)
- Enable MCPServer for `assistant` to generate MCP adapter

3) Generate
```
go install goa.design/goa/v3/cmd/goa@v3.22.2
goa gen <module>/design
goa example <module>/design   # won’t overwrite existing files
```

4) Example server: Serve JSON‑RPC at `/rpc` (cmd/goa_mcp_assistant).

---

## JSON‑RPC & SSE Conventions

- Initialize: negotiate protocolVersion; advertise capabilities (tools/resources/prompts).
- ToolsList: return tool name, description, JSON Schema for arguments.
- ToolsCall: `{ name, arguments }`.
- SSE events: `{ phase: "planning|writing|generating|testing|done", message, percent? }`.
- Errors: JSON‑RPC codes −32700/−32600/−32601/−32602/−32603; error events for streaming.

---

## Central Tool Registry

- `internal/registry/tools.go`:
  - `var Tools map[string]ToolSpec` with Name, Description, Schema, Examples, Streaming, Handler.
- `internal/registry/list.go`: build ToolsList payload.
- `internal/registry/help.go`: implement `tool.help` (return schema + canonical examples).

---

## Write Tools Safety Contract (enforced)

Applies to all write tools (system/design/diagrams/observability/clients/testing/workspace/http/grpc):
- `path` required to bound writes; resolve & verify under repo root.
- `dryRun` supported (or use plan/apply): return plan + diffs without writing.
- Never write outside repo or under `gen/` (except via `goa gen`).
- Fail fast on dirty worktree unless `force` is set; include actionable error.
- Standardized streaming progress events; per‑path lock for gen/apply.

---

## Implementation per Tool Category

### A) System & Workspace

1) `system.new` (streaming)
- Input: `module`, `services[]`, `transports[]?`, `streaming?`, `observability?`, `ci?`, `diagrams?`, `workspace?`, `dryRun?`.
- Plan repository tree (go.mod, README, design/, services/, scripts/, CI, diagrams/, docs/).
- Top‑level design imports service designs via blank imports; wire model/testing plugins as per flags.
- Shared types in `design/types` with `Meta("struct:pkg:path", "<module>/gen/types")`.
- If `observability`: add Clue/OTel to mains (HTTP/gRPC).
- If `dryRun`: return plan only; else apply, `go mod tidy`, `goa gen` (and `goa example` for first scaffold).

2) `system.plan` (streaming)
- Compute plan as above; never write.

3) `system.apply` (streaming)
- Input: `path`, `plan`, `force?`.
- Verify safety, apply plan atomically, `go mod tidy`, emit progress.

4) `system.upgrade` (streaming)
- Input: `path`, `versions{ goa?, clue? }`, `dryRun?`.
- `go get` versions + `go mod tidy`; optional `goa gen`; summarize diffs.

5) `system.validate` (non‑streaming)
- Checks: `gen_drift`, `diagram_drift`, `gen_integrity`, `imports`, `middleware_order`.
- Output: `{ status, checks[], actions[] }`.

### B) Service & Design

6) `scaffold.service` (streaming)
- Input: `module|path`, `service`, `transports[]?`, `streaming?`, `ci?`, `license?`.
- Create `services/<service>` with minimal design/mains; append blank import to top‑level design; `goa gen`.

7) `design.method.add` (streaming)
- Input: `path`, `service`, `method`, `payload?`, `result?`, `errors[]?`, `transports[]?`, `streaming?`.
- Append DSL safely (format/goimports), `goa gen`; handle conflicts.

8) `design.review` (non‑streaming)
- Return a structured report with suggestions (naming, errors, transports, streaming, security).

### C) Code Generation

9) `codegen.generate` (streaming)
- Input: `path`, `example?`.
- `go mod tidy`, `goa gen`, optional `goa example`; optionally `go build` mains.

### D) Diagrams (Model / C4)

10) `diagrams.configure` (non‑streaming)
- Input: `path`, `import`, `containerFormat?`, `excludedTags[]?`, `complete?`.
- Insert model plugin DSL; create Model design; seed C4 views.

11) `diagrams.generate` (non‑streaming)
- Input: `path`, `mode: serve|svg|structurizr`, `generateDSL=true`, `outDir?`, `stz?`, `import?`.
- If `generateDSL`: derive Model DSL from Goa design first; `mdl serve` / export / `stz put`.

12) `diagrams.check` (non‑streaming)
- Input: `path`, `failOnDrift?`.
- Compare Goa design and Model DSL; return discrepancies; optionally fail.

### E) Observability (Clue + OpenTelemetry)

13) `observability.setup` (non‑streaming)
- Input: `path`, `exporters{ otlp?, prometheus?, jaeger? }`, `debugPort?`, `healthPort?`, `sampling?`.
- Wire Clue log/debug endpoints; OTel middleware/interceptors; health endpoints.

### F) Clients & Contracts

14) `clients.scaffold` (streaming)
- Input: `path`, `fromService`, `toService`, `transport`, `package?`, `methods[]?`, `mocks{}`.
- Create transport‑agnostic client wrapper with domain types; generate mocks via cmg for the client interface.

### G) HTTP/gRPC Configuration

15) `http.cors.configure` (non‑streaming)
- Input: `path`, `service`, `origins[]`, `methods[]`, `headers[]`, `credentials`.
- Import v3 CORS DSL and apply config.

16) `http.middleware.add` (non‑streaming)
- Input: `path`, `service`, `middlewares[]`.
- Order: `otelhttp` → `debug.HTTP()` → `log.HTTP(ctx)`; validate in `system.validate`.

17) `grpc.interceptors.add` (non‑streaming)
- Input: `path`, `service`, `interceptors[]`.
- Apply to gRPC server/client setup.

### H) Pulse

18) `pulse.explain` (non‑streaming) — overview.
19) `pulse.rmap.new` (streaming) — integrate replicated map; examples + health.
20) `pulse.stream.new` (streaming) — scaffold stream, topics, producers/consumers.
21) `pulse.worker_pool.configure` (streaming) — configure pool; health/metrics.

### I) Testing (Goa Testing Plugin)

22) `testing.configure` (streaming)
- Input: `path`, `services[]?`.
- Import testing plugin DSL; seed harness; note cmg for client mocks in tests.

23) `testing.scenario.add` (streaming)
- Input: `path`, `service`, `method`, `transport?`.
- Add plugin‑based scenario stub.

### J) Design Conventions & Workspace

24) `design.conventions.apply` (streaming)
- Input: `path`, `conventions{ pagination|filtering|error types|ID types }`.
- Apply across services; `goa gen`.

25) `workspace.module.add` (streaming)
- Input: `path`, `service`.
- Create module; `go work use`; update imports.

26) `workspace.module.remove` (streaming)
- Input: `path`, `service`.
- Remove module; `go work sync`.

### K) Plugins (Extending Goa)

27) `plugin.explain` (non‑streaming) — DSL/expr/codegen hooks.
28) `plugin.new` (streaming) — scaffold plugin skeleton + tests/examples.
29) `plugin.review` (non‑streaming) — static analysis of plugin repo.

### L) Help & Discoverability

30) `tool.help` (non‑streaming)
- Input: `name` (tool name)
- Output: JSON Schema for arguments + canonical examples

---

## Streaming Infrastructure

- SSE helpers:
  - `progress.Emit(ctx, stream, phase, message, percent?)`
  - `progress.Done(ctx, stream, finalMessage)`
  - `errorEvent.Emit(ctx, stream, code, message)`
- Cancellation: check `ctx.Done()` between phases; abort safely.
- Per‑path locks: serialize codegen/plan/apply operations.

---

## File System & Planning

- `fs/plan.go`:
  - `Plan{ creates[]: File, modifies[]: Modify, deletes[]: File, warnings[]: string }`
  - `File{ path, content }`, `Modify{ path, oldHash, newHash, diff }`
- `fs/apply.go`:
  - Atomic writes (temp + rename), symlink & boundary checks, honor `force`.
- `fs/utils.go`:
  - Path clean/resolve, hashing, template rendering.

---

## External Commands (exec)

- `exec/goa.go`: run `goa gen`, `goa example`.
- `exec/mod.go`: `go mod tidy`, `go get <module>@<version>`.
- `exec/cmg.go`: `cmg gen <package>`.
- `exec/mdl.go`: `mdl serve`, export SVG, Structurizr.
- `exec/git.go`: `status`, `diff` helpers.

---

## Testing the MCP Server

- Initialize → tools/list → tools/call (success + error paths).
- Streaming validation: progress events then final response; cancellation behavior.
- Plan/apply round‑trip in temp workspace.
- Safety: attempt outside writes/edits under `gen/`; ensure rejection.
- diagrams.generate: ensure DSL generation precedes serve/export; URL returned.
- clients.scaffold: interface + factory + cmg mocks compiled.
- testing.configure/scenario.add: harness created, scenarios stubbed.

---

## CI for the MCP Project

- `golangci-lint run`, `go test ./...`.
- Optional: generation guard for assistant’s own code.
- Optional: e2e script (curl JSON‑RPC) for smoke testing.

---

## Acceptance Criteria

- Tools match spec from docs/design/assistant_mcp.md with accurate descriptions & schemas.
- Streaming tools emit standardized progress and final response; cancellation works.
- Safety contract enforced: no writes outside repo or under `gen/` manually.
- `system.new` and `scaffold.service` create compilable projects; `codegen.generate` passes; mains build.
- Diagrams configured/generated/checked; drift guard wired by default.
- `clients.scaffold` produces transport‑agnostic client + cmg mocks.
- Testing tools integrate Goa testing plugin; scenario stubs created.
- `design.method.add` safely appends DSL; `goa gen` produces code.
- `tool.help` returns JSON Schema and canonical examples for each tool.
- `system.validate` reports checks and recommended actions.

---

## Implementation Sequencing (Recommended)

1) Skeleton server (Goa MCP) + ToolsList stub
2) Registry + tool.help + schemas/examples
3) Streaming/event helpers + write safety
4) `system.new/plan/apply`
5) `codegen.generate` + `system.validate`
6) `scaffold.service` + `design.method.add` + `design.review`
7) `diagrams.configure/generate/check`
8) `observability.setup` + HTTP/GRPC config tools
9) `clients.scaffold` (cmg integration)
10) `testing.configure/scenario.add`
11) `workspace.module.add/remove` + `design.conventions.apply`
12) `plugin.explain/new/review`
13) Full validation + e2e tests

---

## Notes & Caveats

- No DevOps targets (Docker/K8s/Helm) — out of scope.
- No separate OpenAPI/proto tools — Goa has a single generator; avoid duplication.
- Keep code paths OS‑agnostic; use atomic file writes and robust path checks.

# MCP Protocol Compliance Test Scenarios (new shape)

scenarios:
  - name: tools_call_typed_error_invalid_params
    defaults:
      client: jsonrpc.mcp_assistant
    pre:
      auto_initialize: true
    steps:
      - name: call_missing_field
        op: ToolsCall
        headers:
          Accept: text/event-stream
        input:
          name: analyze_sentiment
          arguments: { text: "" }
        stream_expect:
          min_events: 1
          events:
            - event: error
              data:
                error: { code: -32602 }

  - name: tools_call_typed_error_method_not_found
    defaults:
      client: jsonrpc.mcp_assistant
    pre:
      auto_initialize: true
    steps:
      - name: call_unknown_tool
        op: ToolsCall
        headers:
          Accept: text/event-stream
        input:
          name: does_not_exist
          arguments: {}
        stream_expect:
          min_events: 1
          events:
            - event: error
              data:
                error: { code: -32601 }
  - name: initialize_basic
    defaults:
      client: jsonrpc.mcp_assistant
    pre:
      auto_initialize: false
    steps:
      - name: initialize
        op: Initialize
        input:
          protocolVersion: "2025-06-18"
          capabilities: { tools: true, resources: true, prompts: true }
          clientInfo: { name: "test-client", version: "1.0.0" }
        expect:
          status: success
          result:
            protocolVersion: "2025-06-18"

  - name: initialize_tools_only
    defaults:
      client: jsonrpc.mcp_assistant
    pre:
      auto_initialize: false
    steps:
      - name: initialize
        op: Initialize
        input:
          protocolVersion: "2025-06-18"
          capabilities: { tools: true, resources: false, prompts: false }
          clientInfo: { name: "test-client", version: "1.0.0" }
        expect:
          status: success
          result:
            protocolVersion: "2025-06-18"

  - name: initialize_unsupported_version
    defaults:
      client: jsonrpc.mcp_assistant
    pre:
      auto_initialize: false
    steps:
      - name: initialize_bad_version
        op: Initialize
        input:
          protocolVersion: "1.0.0"
          capabilities: {}
          clientInfo: { name: "test-client", version: "1.0.0" }
        expect:
          status: error
          error: { code: -32602, message: "Unsupported protocol version" }

  - name: initialize_twice
    defaults:
      client: jsonrpc.mcp_assistant
    pre:
      auto_initialize: false
    steps:
      - name: init1
        op: Initialize
        input:
          protocolVersion: "2025-06-18"
          capabilities: {}
          clientInfo: { name: "test-client", version: "1.0.0" }
        expect:
          status: success
          result: { protocolVersion: "2025-06-18" }
      - name: init2
        op: Initialize
        input:
          protocolVersion: "2025-06-18"
          capabilities: {}
          clientInfo: { name: "test-client", version: "1.0.0" }
        expect:
          status: error
          error: { code: -32602, message: "Already initialized" }

  - name: call_before_init
    defaults:
      client: jsonrpc.mcp_assistant
    pre:
      auto_initialize: false
    steps:
      - name: tools_list_before_init
        op: ToolsList
        input: {}
        expect:
          status: error
          error: { code: -32602, message: "Not initialized" }

  - name: prompts_list_before_init
    defaults:
      client: jsonrpc.mcp_assistant
    pre:
      auto_initialize: false
    steps:
      - name: prompts_before
        op: PromptsList
        input: {}
        expect:
          status: error
          error: { code: -32602, message: "Not initialized" }

  - name: resources_list_before_init
    defaults:
      client: jsonrpc.mcp_assistant
    pre:
      auto_initialize: false
    steps:
      - name: resources_before
        op: ResourcesList
        input: {}
        expect:
          status: error
          error: { code: -32602, message: "Not initialized" }

  - name: invalid_method
    defaults:
      client: jsonrpc.mcp_assistant
    pre:
      auto_initialize: false
    steps:
      - name: invalid_op
        op: InvalidOp
        input: {}
        expect:
          status: error
          error: { code: -32601, message: "Method not found" }

  - name: initialize_missing_version
    defaults:
      client: jsonrpc.mcp_assistant
    pre:
      auto_initialize: false
    steps:
      - name: init_missing
        op: Initialize
        input:
          capabilities: {}
          clientInfo: { name: "t", version: "1" }
        expect:
          status: error
          error: { code: -32602 }

  - name: initialize_fields
    defaults:
      client: jsonrpc.mcp_assistant
    pre:
      auto_initialize: false
    steps:
      - name: init_fields
        op: Initialize
        input:
          protocolVersion: "2025-06-18"
          capabilities: { tools: true, resources: true, prompts: true }
          clientInfo: { name: "runner", version: "1.0.0" }
        expect:
          status: success
          result:
            serverInfo: { name: "assistant-mcp", version: "1.0.0" }
            capabilities: {}

  - name: ping_basic
    defaults:
      client: jsonrpc.mcp_assistant
    pre:
      auto_initialize: false
    steps:
      - name: ping
        op: Ping
        input: {}
        expect:
          status: success

  - name: notification_no_response
    defaults:
      client: jsonrpc.mcp_assistant
    pre:
      auto_initialize: true
    steps:
      - name: notify_status_update
        op: NotifyStatusUpdate
        notification: true
        input:
          type: info
          message: "Testing notification"
        expect:
          status: no_response

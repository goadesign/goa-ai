// Code generated by goa vX, DO NOT EDIT.
//
// progress tool codecs
//
// Command:

package progress

import (
	"encoding/json"
	"errors"
	"fmt"
	types "goa.design/goa-ai/gen/types"
	"goa.design/goa-ai/runtime/agent/tools"
	goa "goa.design/goa/v3/pkg"
	"strings"
)

var (
	// SetStepStatusPayloadCodec serializes values of type *SetStepStatusPayload to canonical JSON.
	SetStepStatusPayloadCodec = tools.JSONCodec[*SetStepStatusPayload]{
		ToJSON:   MarshalSetStepStatusPayload,
		FromJSON: UnmarshalSetStepStatusPayload,
	}
	// SetStepStatusResultCodec serializes values of type *SetStepStatusResult to canonical JSON.
	SetStepStatusResultCodec = tools.JSONCodec[*SetStepStatusResult]{
		ToJSON:   MarshalSetStepStatusResult,
		FromJSON: UnmarshalSetStepStatusResult,
	}
	// setStepStatusPayloadCodec provides an untyped codec for *SetStepStatusPayload.
	setStepStatusPayloadCodec = tools.JSONCodec[any]{
		ToJSON: func(v any) ([]byte, error) {
			// Prefer typed marshal when the value matches the expected type.
			if typed, ok := v.(*SetStepStatusPayload); ok {
				return MarshalSetStepStatusPayload(typed)
			}
			return nil, fmt.Errorf("invalid value type for *SetStepStatusPayload: %T", v)
		},
		FromJSON: func(data []byte) (any, error) {
			return UnmarshalSetStepStatusPayload(data)
		},
	}
	// setStepStatusResultCodec provides an untyped codec for *SetStepStatusResult.
	setStepStatusResultCodec = tools.JSONCodec[any]{
		ToJSON: func(v any) ([]byte, error) {
			// Prefer typed marshal when the value matches the expected type.
			if typed, ok := v.(*SetStepStatusResult); ok {
				return MarshalSetStepStatusResult(typed)
			}
			return nil, fmt.Errorf("invalid value type for *SetStepStatusResult: %T", v)
		},
		FromJSON: func(data []byte) (any, error) {
			return UnmarshalSetStepStatusResult(data)
		},
	}
)
var SetStepStatusPayloadFieldDescs = map[string]string{
	"note":    "Optional note about progress.",
	"status":  "New step status.",
	"step_id": "Step identifier.",
}

// ValidationError wraps a validation failure and exposes issues that callers
// can use to build retry hints. It implements error and an Issues() accessor.
type ValidationError struct {
	msg          string
	issues       []*tools.FieldIssue
	descriptions map[string]string
}

func (e ValidationError) Error() string {
	return e.msg
}
func (e ValidationError) Issues() []*tools.FieldIssue {
	if len(e.issues) == 0 {
		return nil
	}
	out := make([]*tools.FieldIssue, len(e.issues))
	copy(out, e.issues)
	return out
}
func (e ValidationError) Descriptions() map[string]string {
	if len(e.descriptions) == 0 {
		return nil
	}
	out := make(map[string]string, len(e.descriptions))
	for k, v := range e.descriptions {
		out[k] = v
	}
	return out
}

// newValidationError converts a goa.ServiceError (possibly merged) into a
// ValidationError with structured FieldIssue entries. It trims any leading
// "body." from field names for conciseness.
func newValidationError(err error) error {
	if err == nil {
		return nil
	}
	var se *goa.ServiceError
	if !errors.As(err, &se) {
		return err
	}
	hist := se.History()
	issues := make([]*tools.FieldIssue, 0, len(hist))
	for _, h := range hist {
		var field string
		if h.Field != nil {
			field = *h.Field
		}
		if strings.HasPrefix(field, "body.") {
			field = strings.TrimPrefix(field, "body.")
		}
		issues = append(issues, &tools.FieldIssue{Field: field, Constraint: h.Name})
	}
	if len(issues) == 0 {
		return err
	}
	return &ValidationError{
		msg:    err.Error(),
		issues: issues,
	}
}
func enrichSetStepStatusPayloadValidationError(err error) error {
	ve, ok := err.(*ValidationError)
	if !ok || ve == nil {
		return err
	}
	if len(ve.issues) == 0 {
		return err
	}
	m := make(map[string]string)
	for _, is := range ve.issues {
		if d, ok := SetStepStatusPayloadFieldDescs[is.Field]; ok && d != "" {
			m[is.Field] = d
		}
	}
	ve.descriptions = m
	return ve
}
func enrichSetStepStatusPayloadJSON2ValidationError(err error) error {
	ve, ok := err.(*ValidationError)
	if !ok || ve == nil {
		return err
	}
	if len(ve.issues) == 0 {
		return err
	}
	m := make(map[string]string)
	ve.descriptions = m
	return ve
}

// PayloadCodec returns the generic codec for the named tool payload.
func PayloadCodec(name string) (*tools.JSONCodec[any], bool) {
	switch name {
	case "progress.set_step_status":
		return &setStepStatusPayloadCodec, true
	default:
		return nil, false
	}
}

// ResultCodec returns the generic codec for the named tool result.
func ResultCodec(name string) (*tools.JSONCodec[any], bool) {
	switch name {
	case "progress.set_step_status":
		return &setStepStatusResultCodec, true
	default:
		return nil, false
	}
}

// ArtifactCodec returns the generic codec for the named tool artifact when declared.
func ArtifactCodec(name string) (*tools.JSONCodec[any], bool) {
	switch name {
	default:
		return nil, false
	}
}

// MarshalSetStepStatusPayload serializes *SetStepStatusPayload into JSON.
func MarshalSetStepStatusPayload(v *SetStepStatusPayload) ([]byte, error) {
	if v == nil {
		return nil, fmt.Errorf("setStepStatusPayload is nil")
	}
	return json.Marshal(v)
}

// UnmarshalSetStepStatusPayload deserializes JSON into *SetStepStatusPayload.
func UnmarshalSetStepStatusPayload(data []byte) (*SetStepStatusPayload, error) {
	if len(data) == 0 {
		return nil, fmt.Errorf("setStepStatusPayload JSON is empty")
	}
	// Decode into JSON body (server body style) then transform.
	// Note: Agent used-tools perform lenient decode (no required-field validation here).
	var raw SetStepStatusPayloadJSON2
	if err := json.Unmarshal(data, &raw); err != nil {
		return nil, fmt.Errorf("decode setStepStatusPayload: %w", err)
	}
	var err error
	if raw.StepID == nil {
		err = goa.MergeErrors(err, goa.MissingFieldError("step_id", "raw"))
	}
	if raw.Status == nil {
		err = goa.MergeErrors(err, goa.MissingFieldError("status", "raw"))
	}
	if raw.Status != nil {
		if !(string(*raw.Status) == "pending" || string(*raw.Status) == "in_progress" || string(*raw.Status) == "completed" || string(*raw.Status) == "blocked") {
			err = goa.MergeErrors(err, goa.InvalidEnumValueError("raw.status", string(*raw.Status), []any{"pending", "in_progress", "completed", "blocked"}))
		}
	}
	if err != nil {
		err = newValidationError(err)
		return nil, err
	}
	// Transform into final type
	v := &SetStepStatusPayload{
		StepID: *raw.StepID,
		Status: types.Status(*raw.Status),
		Note:   raw.Note,
	}
	return v, nil
}

// MarshalSetStepStatusResult serializes *SetStepStatusResult into JSON.
func MarshalSetStepStatusResult(v *SetStepStatusResult) ([]byte, error) {
	if v == nil {
		return nil, fmt.Errorf("setStepStatusResult is nil")
	}
	return json.Marshal(v)
}

// UnmarshalSetStepStatusResult deserializes JSON into *SetStepStatusResult.
func UnmarshalSetStepStatusResult(data []byte) (*SetStepStatusResult, error) {
	if len(data) == 0 {
		return nil, fmt.Errorf("setStepStatusResult JSON is empty")
	}
	// Decode into JSON body (server body style) then transform.
	// Note: Agent used-tools perform lenient decode (no required-field validation here).
	var raw SetStepStatusResultJSON2
	if err := json.Unmarshal(data, &raw); err != nil {
		return nil, fmt.Errorf("decode setStepStatusResult: %w", err)
	}
	// Transform into final type
	v := &SetStepStatusResult{}
	return v, nil
}

// Transform helpers

// ValidateSetStepStatusPayloadJSON2 validates values of type *SetStepStatusPayloadJSON2.
func ValidateSetStepStatusPayloadJSON2(body *SetStepStatusPayloadJSON2) (err error) {
	if body.StepID == nil {
		err = goa.MergeErrors(err, goa.MissingFieldError("step_id", "body"))
	}
	if body.Status == nil {
		err = goa.MergeErrors(err, goa.MissingFieldError("status", "body"))
	}
	if body.Status != nil {
		if !(string(*body.Status) == "pending" || string(*body.Status) == "in_progress" || string(*body.Status) == "completed" || string(*body.Status) == "blocked") {
			err = goa.MergeErrors(err, goa.InvalidEnumValueError("body.status", string(*body.Status), []any{"pending", "in_progress", "completed", "blocked"}))
		}
	}
	return
}

// ValidateSetStepStatusResultJSON2 validates values of type *SetStepStatusResultJSON2.
func ValidateSetStepStatusResultJSON2(body *SetStepStatusResultJSON2) (err error) {

	return
}

// ValidateStatus validates values of type types.Status.
func ValidateStatus(body types.Status) (err error) {
	if !(string(body) == "pending" || string(body) == "in_progress" || string(body) == "completed" || string(body) == "blocked") {
		err = goa.MergeErrors(err, goa.InvalidEnumValueError("body", string(body), []any{"pending", "in_progress", "completed", "blocked"}))
	}
	return
}

// ValidateStatusChangedEvent validates values of type *types.StatusChangedEvent.
func ValidateStatusChangedEvent(body *types.StatusChangedEvent) (err error) {
	if !(string(body.Status) == "pending" || string(body.Status) == "in_progress" || string(body.Status) == "completed" || string(body.Status) == "blocked") {
		err = goa.MergeErrors(err, goa.InvalidEnumValueError("body.status", string(body.Status), []any{"pending", "in_progress", "completed", "blocked"}))
	}
	return
}
